<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" href="css/examples-styles.css" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">

	<title>Arduino-Guay Piano</title>

	<link rel="stylesheet" type="text/css" href="css/abcjs-audio.css">
	<style>
		main {
			max-width: 770px;
			margin: 0 auto;
		}

		.feedback {
			height: 600px;
			font-family: Arial, "sans-serif";
		}

		.highlight {
			fill: #0a9ecc;
		}

		.abcjs-cursor {
			stroke: red;
		}

		.audio-error {
			color: red;
			border: 2px solid red;
			padding: 10px;
		}

		.click-explanation {
			color: red;
			font-style: italic;
		}

		.beat {
			font-weight: bold;
		}

		.label {
			color: #888888;
		}

		.midi {
			margin-top: 20px;
			margin-left: 5px;
		}

		.keyboard-holder {
			margin: 30px auto;
			height: 200px;
			position: relative;
			user-select: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-o-user-select: none;
		}

		.key {
			position: absolute;
			font-family: Helvetica;
			font-weight: 100;
			font-size: 12px;
			border: 1px solid rgba(32, 32, 32, 0.2);
			border-radius: 0px 0px 5px 5px;
			cursor: pointer;
			box-shadow: 0px 5px 1px rgba(32, 32, 32, 0.2);
			-webkit-transition: margin 0.05s ease, background-color 0.05s ease, box-shadow 0.05s ease;
		}

		.key:hover {
			background-color: rgb(255, 192, 32);
		}

		.key .label {
			position: absolute;
			bottom: 5px;
			text-align: center;
			left: 0px;
			right: 0px;
		}

		.black {
			background-color: rgb(32, 32, 32);
			color: #ffffff;
			z-index: 1;
			text-shadow: 0px -1px 1px rgba(255, 255, 255, 0.5);
			width: 30px;
			height: 110px;
		}

		.white {
			background-color: #ffffff;
			color: rgb(32, 32, 32);
			z-index: 0;
			text-shadow: 0px 1px 1px rgba(32, 32, 32, 0.5);
			width: 40px;
			height: 180px;
		}

		.izqda {
			background-color: #eb9999;
		}

		.drcha {
			background-color: #999feb;
		}
	</style>

	<script src="js/abcjs-basic.js" type="text/javascript"></script>
	<script type="text/javascript">
		var hayMidi = false;
		var midiOut = [];
		var chkDer, chkIzq;
		var timer;

		function connect() {
			navigator.requestMIDIAccess()
				.then(
					(midi) => midiReady(midi),
					(err) => console.log('Something went wrong', err));
		}

		function midiReady(midi) {
			// Also react to device changes.
			midi.addEventListener('statechange', (event) => initDevices(event.target));
			initDevices(midi); // see the next section!
		}

		function initDevices(midi) {
			// MIDI devices that you send data to.
			const outputs = midi.outputs.values();
			for (let output = outputs.next(); output && !output.done; output = outputs.next()) {
				midiOut.push(output.value);
			}
			hayMidi = midiOut.length;
		}

		function enviar(nota, on, instrumento) {
			if (!hayMidi) {
				return;
			}
			let cmd = '' + (on ? 1 : 0) + nota;
			if (on == 1) {
				midiOut[0].send([0x90 + instrumento, nota, 127]);
				if (midiOut[1]) {
					midiOut[1].send([0x90 + instrumento, nota, 20]);
				}
			} else {
				midiOut[0].send([0x90 + instrumento, nota, 0]);
				if (midiOut[1]) {
					midiOut[1].send([0x90 + instrumento, nota, 0]);
				}
			}
		}

		class TimerNotas {
			PRIMERA_NOTA = 24;
			msBPM = 0;

			apagarNota(nota) {
				//console.log('(' + (Date.now()-t0) + ') Nota off: ' + nota);
				enviar(nota.pitch, 0, nota.instrument);
				var tecla = document.querySelector("#n" + nota.pitch);
				if (tecla) {
					tecla.classList.remove(nota.instrument == 1 ? "izqda" : "drcha");
				}
			}

			encederNota(notas) { // tmpNegras = 1 para negra
				//console.log('Nota on: ' + nota);
				notas.forEach(nota => {
					enviar(nota.pitch, 1, nota.instrument);
					var tecla = document.querySelector("#n" + nota.pitch);
					if (tecla) {
						tecla.classList.add(nota.instrument == 1 ? "izqda" : "drcha");
					}
					setTimeout(this.apagarNota, nota.duration * this.msBPM, nota);
				});
				// TODO Enceder nota
			}

			setMsMedida(ms) {
				this.msBPM = ms;
			}

			setTic(bpm) {
				this.msBPM = 60000 / bpm;
				console.log('BPM = ' + this.msBPM + ' ms');
			}

		}

		function CursorControl() {
			t0 = Date.now();
			var self = this;
			timer = new TimerNotas();

			self.onStart = function () {
				var svg = document.querySelector("#paper svg");
				var cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
				cursor.setAttribute("class", "abcjs-cursor");
				cursor.setAttributeNS(null, 'x1', 0);
				cursor.setAttributeNS(null, 'y1', 0);
				cursor.setAttributeNS(null, 'x2', 0);
				cursor.setAttributeNS(null, 'y2', 0);
				svg.appendChild(cursor);
				t0 = Date.now();
			};
			self.beatSubdivisions = 1;
			self.onBeat = function (beatNumber, totalBeats, totalTime) {
				//console.log('(' + (Date.now() - t0) + ') : ' + beatNumber );
				t0 = Date.now();
				if (!self.beatDiv)
					self.beatDiv = document.querySelector(".beat");
				self.beatDiv.innerText = "Beat: " + beatNumber + " Total: " + totalBeats + " Total time: " + totalTime;
				//ABCJS.synth.playEvent([{"cmd":"note","pitch":76+beatNumber%4,"volume":105,"start":0,"duration":0.125,"instrument":10,"gap":0}]);
			};
			self.onEvent = function (ev) {
				//console.log(ev);
				if (ev.midiPitches && ev.midiPitches[0]) {
					timer.encederNota(ev.midiPitches);
				}
				if (ev.measureStart && ev.left === null)
					return; // this was the second part of a tie across a measure line. Just ignore it.

				var lastSelection = document.querySelectorAll("#paper svg .highlight");
				for (var k = 0; k < lastSelection.length; k++)
					lastSelection[k].classList.remove("highlight");
				/*
				var el = document.querySelector(".feedback").innerHTML = "<div class='label'>Current Note:</div>" + JSON.stringify(ev, null, 4);
				for (var i = 0; i < ev.elements.length; i++) {
					var note = ev.elements[i];
					for (var j = 0; j < note.length; j++) {
						note[j].classList.add("highlight");
					}
				}
				*/
				var cursor = document.querySelector("#paper svg .abcjs-cursor");
				if (cursor) {
					cursor.setAttribute("x1", ev.left - 2);
					cursor.setAttribute("x2", ev.left - 2);
					cursor.setAttribute("y1", ev.top);
					cursor.setAttribute("y2", ev.top + ev.height);
					document.querySelector("#paper").scrollTo(0, ev.top - 100);
				}
			};
			self.onFinished = function () {
				var els = document.querySelectorAll("svg .highlight");
				for (var i = 0; i < els.length; i++) {
					els[i].classList.remove("highlight");
				}
				var cursor = document.querySelector("#paper svg .abcjs-cursor");
				if (cursor) {
					cursor.setAttribute("x1", 0);
					cursor.setAttribute("x2", 0);
					cursor.setAttribute("y1", 0);
					cursor.setAttribute("y2", 0);
				}
			};
			self.encederNota = function (notas) {
				timer.encederNota(notas);
			};
		}

		var cursorControl = new CursorControl();

		var abc = [];
		var tuneNames = ["Cooleys", "Bill Bailey", "All Notes On Piano"];
		var canciones;
		var currentTune = 0;
		var cancion;

		var synthControl;

		function clickListener(abcElem, tuneNumber, classes, analysis, drag, mouseEvent) {
			var output = "currentTrackMilliseconds: " + abcElem.currentTrackMilliseconds + "<br>" +
				"currentTrackWholeNotes: " + abcElem.currentTrackWholeNotes + "<br>" +
				"midiPitches: " + JSON.stringify(abcElem.midiPitches, null, 4) + "<br>" +
				"gracenotes: " + JSON.stringify(abcElem.gracenotes, null, 4) + "<br>" +
				"midiGraceNotePitches: " + JSON.stringify(abcElem.midiGraceNotePitches, null, 4) + "<br>";
			//document.querySelector(".clicked-info").innerHTML = "<div class='label'>Clicked info:</div>" + output;
			cursorControl.encederNota(abcElem.midiPitches);
			var lastClicked = abcElem.midiPitches;
			if (!lastClicked)
				return;

			ABCJS.synth.playEvent(lastClicked, abcElem.midiGraceNotePitches, synthControl.visualObj.millisecondsPerMeasure()).then(function (response) {
				console.log("note played");
			}).catch(function (error) {
				console.log("error playing note", error);
			});
		}

		var abcOptions = {
			add_classes: true,
			clickListener: self.clickListener,
			responsive: "resize",
			viewportVertical: true
		};

		function load() {
			document.getElementById("start").addEventListener("click", start);
			chkDer = document.getElementById("chkDerecha");
			chkIzq = document.getElementById("chkIzquierda");

			if (ABCJS.synth.supportsAudio()) {
				synthControl = new ABCJS.synth.SynthController();
				synthControl.load("#audio", cursorControl, { displayLoop: true, displayRestart: true, displayPlay: true, displayProgress: true, displayWarp: true });
			} else {
				document.querySelector("#audio").innerHTML = "<div class='audio-error'>Audio is not supported in this browser.</div>";
			}
			cargaTitulos();
			connect();
		}

		function download() {
			if (synthControl)
				synthControl.download(tuneNames[currentTune] + ".wav");
		}

		function start() {
			if (synthControl)
				synthControl.play();
		}

		function compases(txt, num) {
			let tmp = txt.replace(/\n/g, '').replace(/\r/g, '').split('|');
			let res = '';
			let i = 0, j = 0;
			do {
				res += tmp[i] + '|';
				j++; i++;
				if (j == num) {
					j = 0;
					res += '\n';
				}
			} while (i < tmp.length);
			return res;
		}

		function setTune(userAction, abcText) {
			if (!abcText) {
				return;
			}
			let tmp = abcText.split('%-');
			if (tmp.length > 1) {
				abcText = tmp[0] + compases(tmp[1], 6) + tmp[2] + compases(tmp[3], 6);
			}
			let partes = abcText.split('V:');
			cancion = partes[0];
			if (chkDer.checked) {
				cancion += 'V:' + partes[1];
			}
			if (chkIzq.checked && (partes.length > 2)) {
				cancion += 'V:' + partes[2];
			}

			synthControl.disable(true);
			var visualObj = ABCJS.renderAbc("paper", cancion, abcOptions)[0];
			timer.setMsMedida(visualObj.millisecondsPerMeasure());
			// TODO-PER: This will allow the callback function to have access to timing info - this should be incorporated into the render at some point.
			var midiBuffer = new ABCJS.synth.CreateSynth();
			midiBuffer.init({
				//audioContext: new AudioContext(),
				visualObj: visualObj,
				// sequence: [],
				// millisecondsPerMeasure: 1000,
				// debugCallback: function(message) { console.log(message) },
				options: {
					// soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" ,
					// sequenceCallback: function(noteMapTracks, callbackContext) { return noteMapTracks; },
					// callbackContext: this,
					// onEnded: function(callbackContext),
					// pan: [ -0.5, 0.5 ]
				}
			}).then(function (response) {
				console.log(response);
				if (synthControl) {
					let options = {
						drum: "dddd 76 77 77 77 60 30 30 30"
						//drum : "dd 76 77 60 30" 
					};
					synthControl.setTune(visualObj, userAction, options).then(function (response) {
						console.log("Audio successfully loaded.")
					}).catch(function (error) {
						console.warn("Audio problem:", error);
					});
				}
			}).catch(function (error) {
				console.warn("Audio problem:", error);
			});
		}

		function cargaCombo() {
			var ele = document.getElementById('canciones');
			canciones.forEach(function (b) {
				ele.innerHTML += '<option value="' + b.file + '">' + b.titulo + '</option>';
			})
		}

		function cambiaCancion() {
			var ele = document.getElementById('canciones');
			cargaPractica(ele.value);
		}

		function cargaTitulos() {
			fetch('practicas/practicas.json')
				.then(response => response.json())
				.then(jsonResponse => {
					canciones = jsonResponse.Practicas;
					cargaCombo();
					cargaPractica(canciones[0].file);
				});
		}

		function cargaPractica(file) {
			fetch('practicas/' + file)
				.then(response => response.text())
				.then(text => setTune(true, text));
		}

		function siguiente() {
			currentTune++;
			if (currentTune > 3)
				currentTune = 1;
			cargaPractica(currentTune);
		}

		function anterior() {
			if (currentTune > 1)
				currentTune--;
			cargaPractica(currentTune);
		}


	</script>
</head>

<body onload="load()">
	<div class="container">
		<div class="row">
			<span class="col-5">
				<select class="form-select" id="canciones" onchange="cambiaCancion()">
				</select>
			</span>
			<span class="col-1">
				<button type="button" id="start" class="btn btn-primary">Arrancar/Parar</button>
			</span>
		</div>
		<div class="row">
			<span class="col-2">
				<input class="form-check-input" type="checkbox" value="" id="chkIzquierda" checked
					onchange="cambiaCancion()">
				<label class="form-check-label" for="chkIzquierda">
					Mano Izquierda
				</label>
			</span>
			<span class="col-2">
				<input class="form-check-input" type="checkbox" value="" id="chkDerecha" checked
					onchange="cambiaCancion()">
				<label class="form-check-label" for="chkDerecha">
					Mano Derecha
				</label>
			</span>
		</div>
		<div style="width: 900px;margin-left: auto;margin-right: auto;">
			<div id="paper" style="height: 500px;overflow-y: scroll;"></div>
			<div id="audio"></div>
			<p class="beat"></p>
		</div>
		<div id="keyboard" class="keyboard-holder" style="width: 1200px;">
			<div class="white key" id="n36" style="left: 0px;">
				<div class="label">C2</div>
			</div>
			<div class="black key" id="n37" style="left: 20px;">
				<div class="label">C2#</div>
			</div>
			<div class="white key" id="n38" style="left: 35px;">
				<div class="label">D2</div>
			</div>
			<div class="black key" id="n39" style="left: 55px;">
				<div class="label">D2#</div>
			</div>
			<div class="white key" id="n40" style="left: 70px;">
				<div class="label">E2</div>
			</div>
			<div class="white key" id="n41" style="left: 105px;">
				<div class="label">F2</div>
			</div>
			<div class="black key" id="n42" style="left: 125px;">
				<div class="label">F2#</div>
			</div>
			<div class="white key" id="n43" style="left: 140px;">
				<div class="label">G2</div>
			</div>
			<div class="black key" id="n44" style="left: 160px;">
				<div class="label">G2#</div>
			</div>
			<div class="white key" id="n45" style="left: 175px;">
				<div class="label">A2</div>
			</div>
			<div class="black key" id="n46" style="left: 195px;">
				<div class="label">A2#</div>
			</div>
			<div class="white key" id="n47" style="left: 210px;">
				<div class="label">B2</div>
			</div>
			<div class="white key" id="n48" style="left: 245px;">
				<div class="label">C3</div>
			</div>
			<div class="black key" id="n49" style="left: 265px;">
				<div class="label">C3#</div>
			</div>
			<div class="white key" id="n50" style="left: 280px;">
				<div class="label">D3</div>
			</div>
			<div class="black key" id="n51" style="left: 300px;">
				<div class="label">D3#</div>
			</div>
			<div class="white key" id="n52" style="left: 315px;">
				<div class="label">E3</div>
			</div>
			<div class="white key" id="n53" style="left: 350px;">
				<div class="label">F3</div>
			</div>
			<div class="black key" id="n54" style="left: 370px;">
				<div class="label">F3#</div>
			</div>
			<div class="white key" id="n55" style="left: 385px;">
				<div class="label">G3</div>
			</div>
			<div class="black key" id="n56" style="left: 405px;">
				<div class="label">G3#</div>
			</div>
			<div class="white key" id="n57" style="left: 420px;">
				<div class="label">A3</div>
			</div>
			<div class="black key" id="n58" style="left: 440px;">
				<div class="label">A3#</div>
			</div>
			<div class="white key" id="n59" style="left: 455px;">
				<div class="label">B3</div>
			</div>
			<div class="white key" id="n60" style="left: 490px;">
				<div class="label">C4</div>
			</div>
			<div class="black key" id="n61" style="left: 510px;">
				<div class="label">C4#</div>
			</div>
			<div class="white key" id="n62" style="left: 525px;">
				<div class="label">D4</div>
			</div>
			<div class="black key" id="n63" style="left: 545px;">
				<div class="label">D4#</div>
			</div>
			<div class="white key" id="n64" style="left: 560px;">
				<div class="label">E4</div>
			</div>
			<div class="white key" id="n65" style="left: 595px;">
				<div class="label">F4</div>
			</div>
			<div class="black key" id="n66" style="left: 615px;">
				<div class="label">F4#</div>
			</div>
			<div class="white key" id="n67" style="left: 630px;">
				<div class="label">G4</div>
			</div>
			<div class="black key" id="n68" style="left: 650px;">
				<div class="label">G4#</div>
			</div>
			<div class="white key" id="n69" style="left: 665px;">
				<div class="label">A4</div>
			</div>
			<div class="black key" id="n70" style="left: 685px;">
				<div class="label">A4#</div>
			</div>
			<div class="white key" id="n71" style="left: 700px;">
				<div class="label">B4</div>
			</div>
			<div class="white key" id="n72" style="left: 735px;">
				<div class="label">C5</div>
			</div>
			<div class="black key" id="n73" style="left: 755px;">
				<div class="label">C5#</div>
			</div>
			<div class="white key" id="n74" style="left: 770px;">
				<div class="label">D5</div>
			</div>
			<div class="black key" id="n75" style="left: 790px;">
				<div class="label">D5#</div>
			</div>
			<div class="white key" id="n76" style="left: 805px;">
				<div class="label">E5</div>
			</div>
			<div class="white key" id="n77" style="left: 840px;">
				<div class="label">F5</div>
			</div>
			<div class="black key" id="n78" style="left: 860px;">
				<div class="label">F5#</div>
			</div>
			<div class="white key" id="n79" style="left: 875px;">
				<div class="label">G5</div>
			</div>
			<div class="black key" id="n80" style="left: 895px;">
				<div class="label">G5#</div>
			</div>
			<div class="white key" id="n81" style="left: 910px;">
				<div class="label">A5</div>
			</div>
			<div class="black key" id="n82" style="left: 930px;">
				<div class="label">A5#</div>
			</div>
			<div class="white key" id="n83" style="left: 945px;">
				<div class="label">B5</div>
			</div>
			<div class="white key" id="n84" style="left: 980px;">
				<div class="label">C6</div>
			</div>
			<div class="black key" id="n85" style="left: 1000px;">
				<div class="label">C6#</div>
			</div>
			<div class="white key" id="n86" style="left: 1015px;">
				<div class="label">D6</div>
			</div>
			<div class="black key" id="n87" style="left: 1035px;">
				<div class="label">D6#</div>
			</div>
			<div class="white key" id="n88" style="left: 1050px;">
				<div class="label">E6</div>
			</div>
			<div class="white key" id="n89" style="left: 1085px;">
				<div class="label">F6</div>
			</div>
			<div class="black key" id="n90" style="left: 1105px;">
				<div class="label">F6#</div>
			</div>
			<div class="white key" id="n91" style="left: 1120px;">
				<div class="label">G6</div>
			</div>
			<div class="black key" id="n92" style="left: 1140px;">
				<div class="label">G6#</div>
			</div>
			<div class="white key" id="n93" style="left: 1155px;">
				<div class="label">A6</div>
			</div>
			<div class="black key" id="n94" style="left: 1175px;">
				<div class="label">A6#</div>
			</div>
			<div class="white key" id="n95" style="left: 1190px;">
				<div class="label">B6</div>
			</div>
</body>

</html>